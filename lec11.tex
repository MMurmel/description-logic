\lecture{11}{20.05.2021}{}
We will regain termination by the following technique.
\begin{definition}[$\mathcal{ALC}$ blocking]\label{def:blocking}
	An individual name $b$ in an $\mathcal{ALC}$-ABox $\mathcal{A}$ is blocked by an individual name $a$ if
	\begin{itemize}
		\item $a$ is an ancestor of $b$ and
		\item $\func{con}_{\mathcal{A}}(a) \supseteq \func{con}_{\mathcal{A}}(b)$.
	\end{itemize}
	An individual name $b$ is blocked in $\mathcal{A}$ if
	\begin{itemize}
		\item it is blocked by some individual name $a$, or
		\item if one or more of its ancestors is blocked in $\mathcal{A}$.
	\end{itemize}
\end{definition}

The tableau algorithm for $\mathcal{ALC}$ knowledge base consistency uses
\begin{itemize}
	\item the $\sqcap$-rule, the $\sqcup$-rule and the $\forall$-rule without changes,
	\item the new $\sqsubseteq$-rule and
	\item the following modified $\exists$-rule
\end{itemize}

\begin{mdframed}[frametitle= The modified $\exists$-rule]
	Condition: $\mathcal{A}$ contains $a:(\exists r.C)$, but there is no $b$ such that \\$\left\{ (a,b) :r, b:C \right\} \subseteq \mathcal{A}$ and $a$ is not blocked \\
	Action: $\mathcal{A} \leftarrow \mathcal{A} \cup \left\{ (a,d):r, d:C \right\} $ where $d$ is new in $\mathcal{A}$
\end{mdframed}
\begin{definition}[det.\ tableau algorithm for KB consistency]
	\begin{algorithm}[H]
		\caption{consistent($\mathcal{K}$)}
		\label{alg:kb consistent}
		\begin{algorithmic}[1]
			\Require a normalized $\mathcal{ALC}$-KB $(\mathcal{T},\mathcal{A})$
		\If{$\func{expand}(\mathcal{T}, \mathcal{A}) \neq \emptyset$}
				\State \textbf{return} "consistent"
			\Else{}
				\State \textbf{return} "inconsistent"
			\EndIf
		\end{algorithmic}
	\end{algorithm}
	\begin{algorithm}[H]
		\caption{expand($\mathcal{K}$)}
		\label{alg:kb expand}
		\begin{algorithmic}[1]
			\Require a normalized $\mathcal{ALC}$-KB $(\mathcal{T},\mathcal{A})$
			\If{$\mathcal{A}$ is not complete}
				\State select a rule $R$ that is applicable to $\mathcal{A}$ and an assertion or 
				\State a pair of assertions $\alpha$ in $\mathcal{A}$ to which $R$ is applicable
				\If{there is $\mathcal{A}' \in \func{\texttt{exp}}(\mathcal{A},R,\alpha)$ with $\func{expand}(\mathcal{T},\mathcal{A}') \neq \emptyset$}
					\State \textbf{return} $\func{expand}(\mathcal{T},\mathcal{A}')$
				\Else
						\State \textbf{return} $\emptyset$
				\EndIf
			\Else
				\If{$\mathcal{A}$ contains a clash}
					\State \textbf{return} $\emptyset$
				\Else
					\State \textbf{return} $\mathcal{A}$
				\EndIf
			\EndIf
		\end{algorithmic}
	\end{algorithm}
\end{definition}
To show that this decision procedure is correct, we will again need to show:
\begin{enumerate}
	\item Termination
	\item Completeness
	\item Soundness
\end{enumerate}

\begin{lemma}[Termination]
	For each normalized $\mathcal{ALC}$ KB $\mathcal{K}$, $\func{consistent}(\mathcal{K})$ terminates.
\end{lemma}
\begin{proof}
	This proof is similar to the one for lemma \ref{lem:abox termination},
	the only difference being w.r.t.\ the third part of the proof
	that concerns the depth-bound for the trees generated by the algorithm.
	Let $m = \lvert \func{sub}(\mathcal{K}) \rvert$.
	The rules only generate concept assertions for concepts in $\func{sub}(\mathcal{K})$,
	i.e.\ $\func{con}_{\mathcal{A}}(a) \subseteq \func{sub}(\mathcal{K})$.
	Thus, there are at most $2^m$ different such sets.
	\begin{enumerate}
		\item There can be at most $m$ rule applications adding a concept assertion to a given individual,
			and every rule application adds a concept assertion.
		\item The out degree of each tree generated by applications of the modified $\exists$-rule is bounded by $m$.
		\item Since $\func{con}_{\mathcal{A}}(a) \subseteq \func{sub}(\mathcal{K})$ and $\lvert \func{sub}(\mathcal{K}) \rvert = m$,
			any path along tree individuals in the Abos can contain at most $2^m$ individual names
			before it contains two individuals $a, b$ such that $b$ is a descendant of $a$ and
			$\func{con}_{\mathcal{A}}(a) \supseteq \func{con}_{\mathcal{A}}(b)$ (by pigeon-hole-principle).
			Thus, the application of the $\exists$-rule to $b$ and its descendants is blocked.
			Thus, the depth of the trees is bounded by $2^m$.
			\qedhere
	\end{enumerate}
\end{proof}

\begin{lemma}[Soundness]
	If $\func{consistent}(\mathcal{K})$ returns "consistent", then $\mathcal{K}$ is consistent.
\end{lemma}
\begin{proof}
	Let $\mathcal{A}'$ be the set returned by $\func{expand}(\mathcal{K})$.
	We use $\mathcal{A}'$ to construct a suitable model $\mathcal{I} = (\Delta^\mathcal{I}, \cdot^\mathcal{I})$
	of $\mathcal{K}$ in two steps:
	\begin{enumerate}
		\item Construct a new Abos $\mathcal{A}''$ that contains
			\begin{itemize}
				\item those axioms in $\mathcal{A}'$ that do not involve blocked individual names
				\item new "loop-back" role assertions
			\end{itemize}
		\item Use $\mathcal{A}''$ to construct a model of $\mathcal{K}$.
	\end{enumerate}
	1. We start by constructing $\mathcal{A}''$:
	\begin{align*}
		\mathcal{A}'' = &\left\{ a:C \mid a:C \in \mathcal{A}' \text{ and $a$ is not blocked} \right\} \cup \\
						&\left\{ (a,b):r \mid (a,b):r \in \mathcal{A}' \text{ and $b$ is not blocked} \right\} \cup \\
						&\left\{ (a,b'):r \mid (a,b):r \in \mathcal{A}', \text{ $a$ is not blocked and $b$ is blocked by  $b'$} \right\}
	\end{align*}
	Then the following hold:
	\begin{itemize}
		\item $\mathcal{A} \subseteq \mathcal{A}''$ and none of the individual names occurring in $\mathcal{A}''$ is blocked.
			\begin{subproof}
				$\mathcal{A} \subseteq \mathcal{A}''$: since $\mathcal{A} \subseteq \mathcal{A}'$ and for all assertion
				$a:C$ and  $(a,b):r$ both $a$ and $b$ are root individuals
				and thus cannot be blocked.
				Because we only remove blocked individuals, we don't remove assertions from $\mathcal{A}$,
				when going from $\mathcal{A}'$ to $\mathcal{A}''$.

				None of the individuals in $\mathcal{A}''$ are blocked:
				For concept assertions $a:C$ this is trivial by the definition of $\mathcal{A}''$.
				For role assertions $(a,b):r \in \mathcal{A}' \cap \mathcal{A}''$, we know that $b$ is not blocked,
				and thus $a$ cannot be blocked.
				If $(a,b'):r \in \mathcal{A}''$ for $(a,b):r \in \mathcal{A}'$ and $b$ blocked by $b'$,
				we know that $a$ is not blocked.
				But then $b'$ is not blocked since it is equal to $a$ or an ancestor of $a$.
			\end{subproof}

		\item $\func{con}_{\mathcal{A}''}(a) =  \func{con}_{\mathcal{A}'}(a)$ for all individual $a$ occurring in $\mathcal{A}''$ 
			\begin{subproof}
				trivial by definition of  $\mathcal{A}''$
			\end{subproof}

		\item Since $\mathcal{A}'$ is clash-free, and complete, $\mathcal{A}''$ is also clash-free and complete.
			\begin{subproof}
				clash-free: trivial, since  $\mathcal{A}'$ is clash-free
				and we have $\func{con}_{\mathcal{A}''}(a) =  \func{con}_{\mathcal{A}'}(a)$.

				complete: by looking at the rules:
				\begin{itemize}
					\item $\sqcap$-rule: if $a : C \sqcap D \in \mathcal{A}''$,
						then $\func{con}_{\mathcal{A}''}(a) =  \func{con}_{\mathcal{A}'}(a)$ implies
						$a : C \sqcap D \in \mathcal{A}''$.
						Thus, $\left\{ a:C, a:D \right\}\subseteq \mathcal{A}'$.
						$\func{con}_{\mathcal{A}''}(a) =  \func{con}_{\mathcal{A}'}(a)$	yields $\left\{ a:C, a:D \right\}\subseteq \mathcal{A}''$,
						and thus the $\sqcap$-rule is not applicable to $a:C \sqcap D$ in $\mathcal{A}''$.
					\item Similar arguments can be used for the $\sqcup$-rule and the $\sqsubseteq$-rule.
					\item $\exists$-rule: if $a: \exists r.C \in \mathcal{A}''$,
						then $a : \exists r.C \in \mathcal{A}'$ by $\func{con}_{\mathcal{A}''}(a) =  \func{con}_{\mathcal{A}'}(a)$
						and $a$ is not blocked in $\mathcal{A}'$.
						Since $\mathcal{A}'$ is complete, we know that there is a $b$ such that
						$\left\{ (a,b):r, b:C \right\} \subseteq \mathcal{A}'$.
						If $b$ is not blocked, then $\left\{ (a,b):r, b:C \right\} \subseteq \mathcal{A}''$.
						But if $b$ is blocked, then since its predecessor $a$ is not blocked,
						there is a $b' \in \mathcal{A}'$ such that $b$ is blocked by $b'$
						and $b'$ is not blocked.
						Hence, $(a,b'):r \in \mathcal{A}''$.
						Since $\func{con}_{\mathcal{A}'}(b) =  \func{con}_{\mathcal{A}'}(b')$ we have
						$b':C \in \mathcal{A}'$, and by $\func{con}_{\mathcal{A}''}(a) =  \func{con}_{\mathcal{A}'}(a)$ we get
						$b':C \in \mathcal{A}''$.
						Thus, the $\exists$-rule is not applicable to $a: \exists r.C$.
				\end{itemize}
			\end{subproof}
	\end{itemize}
\end{proof}
